/*
* This was ported from MapStory.org to add the timeslider to the map detail page.
* A new viewer should eventually replace this.
* */
var GeoExplorer;gxp.TextSymbolizer.prototype.defaultSymbolizer={vendorOptions:{maxDisplacement:40,autoWrap:40,spaceAround:0,followLine:!1,group:"yes",goodnessOfFit:0.2,conflictResolution:!0,haloColor:"#FFFFFF",haloRadius:1}};
Ext.override(Ext.dd.DragTracker,{onMouseMove:function(a){if(this.active&&Ext.isIE&&!Ext.isIE9&&!a.browserEvent.button)a.preventDefault(),this.onMouseUp(a);else{a.preventDefault();var b=a.getXY(),c=this.startXY;this.lastXY=b;if(!this.active)if(Math.abs(c[0]-b[0])>this.tolerance||Math.abs(c[1]-b[1])>this.tolerance)this.triggerStart(a);else return;this.fireEvent("mousemove",this,a);this.onDrag(a);this.fireEvent("drag",this,a)}}});
GeoExplorer=Ext.extend(gxp.Viewer,{localGeoServerBaseUrl:"",cachedSourceMatch:/mapstory\.dev|mapstory\.org/,cachedSubdomains:["t1","t2","t3","t4"],toggleGroup:"map",mapPanel:null,toolbar:null,capGrid:null,modified:0,popupCache:null,searchTool:null,urlPortRegEx:/^(http[s]?:\/\/[^:]*)(:80|:443)?\//,backgroundContainerText:"UT:Background",connErrorTitleText:"Communication error",connErrorText:"The mapping server did not respond properly. It is likely temporarily down, but should be up soon. If this problem persists please let the administrators know.",
connErrorDetailsText:"Details...",heightLabel:"UT: Height",largeSizeLabel:"UT:Large",layerContainerText:"UT:Map Layers",layerSelectionLabel:"UT:View available data from:",layersContainerText:"UT:Data",layersPanelText:"UT:Layers",mapSizeLabel:"UT: Map Size",metadataFormCancelText:"UT:Cancel",metadataFormSaveAsCopyText:"UT:Save as Copy",metadataFormSaveText:"UT:Save",metaDataHeader:"UT:About this Map",metaDataMapAbstract:"UT:Abstract",metaDataMapTitle:"UT:Title",miniSizeLabel:"UT: Mini",premiumSizeLabel:"UT: Premium",
propertiesText:"UT:Properties",publishActionText:"UT:Publish Map",saveFailMessage:"UT: Sorry, your map could not be saved.",saveFailTitle:"UT: Error While Saving",saveMapText:"UT: Save Map",saveMapAsText:"UT: Save Map As",saveNotAuthorizedMessage:"UT: You Must be logged in to save this map.",smallSizeLabel:"UT: Small",searchMessage:"UT: Search for Map Story Layers",sourceLoadFailureMessage:"UT: Error contacting server.\n Please check the url and try again.",unknownMapMessage:"UT: The map that you are trying to load does not exist.  Creating a new map instead.",
unknownMapTitle:"UT: Unknown Map",widthLabel:"UT: Width",zoomSelectorText:"UT:Zoom level",zoomSliderTipText:"UT: Zoom Level",zoomToLayerExtentText:"UT:Zoom to Layer Extent",constructor:function(a){a=a||{};this.popupCache={};this.addEvents("saved","beforeunload");if(!1!==a.useToolbar)a.tools=(a.tools||[]).concat({ptype:"gxp_playback",id:"playback-tool",outputTarget:"map-bbar",looped:!0,outputConfig:{listeners:{afterlayout:this.addHelpLinks,single:!0},xtype:"app_playbacktoolbar",defaults:{scale:"medium"}}});
Ext.preg("gx_wmssource",gxp.plugins.WMSSource);Ext.preg("gx_olsource",gxp.plugins.OLSource);Ext.preg("gx_googlesource",gxp.plugins.GoogleSource);Ext.util.Observable.observeClass(Ext.data.Connection);Ext.data.Connection.on({beforerequest:function(a,c){var d=c.url instanceof Array?c.url.slice():[c.url];c.url=[];for(var e=d.length-1;0<=e;e--){var f=d[e].replace(this.urlPortRegEx,"$1/");if(this.localGeoServerBaseUrl){if(0==f.indexOf(this.localGeoServerBaseUrl)){c.url.push(f.replace(RegExp("^"+this.localGeoServerBaseUrl),
"/geoserver/"));return}var g=this.localGeoServerBaseUrl.replace(this.urlPortRegEx,"$1/");if(0===f.indexOf(g+"rest/")){c.url.push(f.replace(RegExp("^"+g),"/geoserver/"));return}}this.proxy&&0!==f.indexOf(this.proxy)&&0===f.indexOf(window.location.protocol)&&(f=f.replace(/&$/,"").split("?"),g=Ext.apply(f[1]&&Ext.urlDecode(f[1])||{},c.params),f=Ext.urlAppend(f[0],Ext.urlEncode(g)),delete c.params,c.url.push(this.proxy+encodeURIComponent(f)))}if(!c.url.length)c.url=1==d.length?d[0]:d},requestexception:function(a,
c,d){d.failure||(a=d.url instanceof Array?d.url[0]:d.url,401==c.status&&a.indexOf("http"!=0)&&-1===a.indexOf(this.proxy)?this.authenticate(d):405!=c.status&&"/geoserver/rest/styles"!=a&&this.displayXHRTrouble(c))},scope:this});Ext.util.Observable.observeClass(gxp.form.ColorField);gxp.form.ColorField.on({render:function(a){(new Styler.ColorManager).register(a)}});window.onbeforeunload=function(){if(!1===this.fireEvent("beforeunload"))return"If you leave this page, unsaved changes will be lost."}.createDelegate(this);
Ext.form.ComboBox.prototype.getListParent=function(){return this.el.up(".x-window")||document.body};Ext.Window.prototype.shadow=!1;GeoExplorer.superclass.constructor.apply(this,[a])},addHelpLinks:function(){Ext.getCmp("map-bbar").add("->",{xtype:"container",style:"margin-right: 5px",html:'<a target="_blank" href="http://help.mapstory.org">Help</a> | <a target="_blank" href="http://wiki.mapstory.org/index.php?title=How_To">How-To</a> | <a target="_blank" href="http://mapstory.org/mapstory/manual/">Manual</a>'});
Ext.getCmp("map-bbar").doLayout()},displayXHRTrouble:function(a){a.status&&Ext.Msg.show({title:this.connErrorTitleText,msg:this.connErrorText,icon:Ext.MessageBox.ERROR,buttons:{ok:this.connErrorDetailsText,cancel:!0},fn:function(b){if("ok"==b){var c=new Ext.Window({title:a.status+" "+a.statusText,width:400,height:300,items:{xtype:"container",cls:"error-details",html:a.responseText},autoScroll:!0,buttons:[{text:"OK",handler:function(){c.close()}}]});c.show()}}})},loadConfig:function(a,b){a=Ext.apply(a||
{},{proxy:"/proxy/?url=",rest:"/maps/"});Ext.Ajax.request({url:window.location.href.split("?")[0].replace(/\/view|\/embed|(\/new)|([0-9])$/,"$1$2/data"),success:function(c){var c=Ext.decode(c.responseText,!0),d=(a.tools||[]).concat({ptype:"ms-tool-bar",outputTarget:"map-bbar"},{ptype:"gxp_layermanager",loader:{baseAttrs:{baseParams:{legend_options:"fontAntiAliasing:true;fontSize:11;fontName:Arial;fontColor:#ffffff;fontStyle:bold"}}},outputConfig:{id:"treecontent",autoScroll:!0,tbar:{id:"treetbar"}},
outputTarget:"westpanel"},{ptype:"gxp_zoomtolayerextent",actionTarget:"treecontent.contextMenu"},{ptype:"ms_add_layer",actionTarget:"treetbar"},{ptype:"gxp_removelayer",actionTarget:["treetbar","treecontent.contextMenu"]},{ptype:"app_layerproperties",layerPanelConfig:{gxp_wmslayerpanel:{rasterStyling:!0}},actionTarget:["treetbar","treecontent.contextMenu"]},{ptype:"gxp_styler",outputConfig:{width:400},rasterStyling:!0,actionTarget:["treetbar","treecontent.contextMenu"]},{ptype:"gxp_timeline",id:"timeline-tool",
outputConfig:{title:null},outputTarget:"timeline-container",playbackTool:"playback-tool"},{ptype:"ms_notes_manager",timeline:"timeline-tool",actionTarget:{target:"map-bbar"}},{ptype:"gxp_featuremanager",id:"general_manager",paging:!1,autoSetLayer:!0},{ptype:"gxp_featureeditor",id:"feature-editor",toggleGroup:this.toggleGroup,featureManager:"general_manager",autoLoadFeature:!0,editFeatureActionTip:"Select feature",iconClsEdit:"gxp-icon-getfeatureinfo",actionTarget:{target:"map-bbar",index:13}});Ext.apply(a,
c);a.tools=a.tools||[];a.sources.local.hidden=!0;a.sources.search={ptype:"ms_cataloguesource",url:"/search/api"};var e=Ext.pluck(a.tools,"ptype");Ext.each(d,function(b){if(-1==e.indexOf(b.ptype))a.tools.push(b);else for(var c in a.tools){var d=a.tools[c];if(d.ptype===b.ptype){Ext.applyIf(d,b);break}}});if(this.mapID=a.id)this.on("portalready",this.addHelpLinks,this,{delay:500,single:!0});b.call(this,a)},scope:this})},initMapPanel:function(){var a=[new OpenLayers.Control.Attribution,new OpenLayers.Control.Zoom,
new OpenLayers.Control.Navigation({zoomWheelOptions:{interval:250},dragPanOptions:{enableKinetic:!0}})];this.initialConfig.map?this.initialConfig.map.controls=(this.initialConfig.map.controls||[]).concat(a):this.initialConfig.map={controls:a};this.initialConfig.map&&this.initialConfig.map.bbar?(this.initialConfig.map.bbar.id="map-bbar",this.initialConfig.map.bbar.height=55):this.initialConfig.map=Ext.applyIf(this.initialConfig.map||{},{region:"center",ref:"../main",bbar:{id:"map-bbar",height:40,items:[]}});
GeoExplorer.superclass.initMapPanel.apply(this,arguments);delete this.initialConfig.map.controls;a=new OpenLayers.TileManager({cacheSize:512,tilesPerFrame:24});this.mapPanel.map.tileManager=a;a.addMap(this.mapPanel.map);this.mapPanel.layers.on({add:function(a,c){for(var d=c.length-1;0<=d;d--)if(layer=c[d].getLayer(),!layer.isBaseLayer&&layer instanceof OpenLayers.Layer.Grid){layer.addOptions({transitionEffect:"resize"});var e=layer.url;if(Ext.isString(e)&&("/"===e.charAt(0)&&-1!==e.indexOf("geoserver")&&
e.replace("/geoserver/",this.localGeoServerBaseUrl),-1<e.search(this.cachedSourceMatch)&&this.cachedSubdomains)){for(var f=e.split("://"),g=[],h=0,i=f.slice(-1)[0],j=this.cachedSubdomains.length;h<j;h++)g.push((1<f.length?f[0]+"://":"")+this.cachedSubdomains[h]+"."+i);layer.url=g.concat([e])}if(layer.params&&layer.dimensions&&layer.dimensions.time)layer.params.TILED=!0,layer.params["GWC.FULLWMS"]=""}},scope:this})},initPortal:function(){this.on("ready",function(){this.mapPanel.layers.on({update:function(){this.modified|=
1},add:function(){this.modified|=1},remove:function(){this.modified|=1},scope:this})});this.on("ready",function(){var a=null,b;for(b in this.layerSources)h=this.layerSources[b],h.store&&h instanceof gxp.plugins.WMSSource&&0===h.url.indexOf("/geoserver/wms")&&(a=b,h.store.on("load",function(){h.store.filterBy(function(a){a=a.get("name");return!(/geonode:_map_[0-9]+_annotations/.test(a)||/geonode:annotations_[0-9]+/.test(a))},this)},this));b=null;for(var e in this.tools){var f=this.tools[e];if("gxp_addlayers"===
f.ptype)b=f,b.startSourceId=a}e=window.location.href.split("?");var g;if(1<e.length&&(g=Ext.urlDecode(e[1]).layer)){var h=this.layerSources[a];if(h.lazy)lyrParts=g.split(":"),g=lyrParts[1],h.store.url=h.store.url.replace(/(geoserver)(\/.*?)(wms)/,function(a,b,c,d){return[b].concat(lyrParts,d).join("/")}),h.store.proxy.setUrl(h.store.url),h.initialConfig.url=h.url=h.store.url;this.createLayerRecord({source:a,name:g},function(a){this.mapPanel.layers.add([a]);this.mapPanel.map.zoomToExtent(a.getLayer().maxExtent)},
this)}!g&&!this.mapID&&null!==b&&b.showCapabilitiesGrid()},this);this.on("ready",function(){(new Ext.Element(Ext.DomHelper.append(Ext.DomQuery.selectNode(".olMapViewport"),[{tag:"div",id:"FadeControlContainer"}]))).appendChild(Ext.select(".olControlPanPanel, .olControlZoomPanel"))},this);var a=new Ext.Panel({layout:"fit",id:"westpanel",border:!1,collapsed:!1,collapsible:!0,title:"Layers",split:!0,region:"west",width:250});this.toolbar=new Ext.Toolbar({disabled:!0,id:"paneltbar",items:[]});this.on("ready",
function(){var a=this.toolbar.items.filterBy(function(a){return a.initialConfig&&a.initialConfig.disabled});this.toolbar.enable();a.each(function(a){a.disable()})},this);var b=new Ext.Panel({region:"north",autoHeight:!0,contentEl:"header-wrapper"});Lang.registerLinks();this.portalItems=[b,{region:"center",xtype:"container",layout:"fit",border:!1,hideBorders:!0,items:{layout:"border",deferredRender:!1,tbar:this.toolbar,items:[this.mapPanel,a,{region:"south",height:175,split:!0,collapsed:!0,collapseMode:"mini",
collapsible:!0,id:"timeline-container",header:!1,xtype:"panel",tbar:["->"],layout:"fit"}],ref:"../../main"}}];GeoExplorer.superclass.initPortal.apply(this,arguments)},createTools:function(){var a=[new Ext.Button({tooltip:this.saveMapText,handler:this.showMetadataForm,scope:this,iconCls:"icon-save"}),new Ext.Action({tooltip:this.publishActionText,handler:this.makeExportDialog,scope:this,iconCls:"icon-export",disabled:!this.mapID}),"-"];this.on("saved",function(){a[1].enable();this.modified^=this.modified&
1},this);return a},makeExportDialog:function(){(new Ext.Window({title:this.publishActionText,layout:"fit",width:450,autoHeight:!0,items:[{xtype:"gxp_embedmapdialog",url:this.rest+this.mapID+"/embed"}]})).show()},initMetadataForm:function(){var a=new Ext.form.TextField({width:"95%",fieldLabel:this.metaDataMapTitle,value:this.about.title,allowBlank:!1,enableKeyEvents:!0,listeners:{valid:function(){d.enable();e.enable()},invalid:function(){d.disable();e.disable()}}}),b=new Ext.form.TextArea({width:"95%",
height:200,fieldLabel:this.metaDataMapAbstract,value:this.about["abstract"]}),c=new Ext.FormPanel({bodyStyle:{padding:"5px"},labelAlign:"top",items:[a,b]});c.enable();var d=new Ext.Button({text:this.metadataFormSaveAsCopyText,disabled:!this.about.title,handler:function(){this.about.title=a.getValue();this.about["abstract"]=b.getValue();this.metadataForm.hide();this.save(!0)},scope:this}),e=new Ext.Button({text:this.metadataFormSaveText,disabled:!this.about.title,handler:function(){this.about.title=
a.getValue();this.about["abstract"]=b.getValue();this.metadataForm.hide();this.save()},scope:this});this.metadataForm=new Ext.Window({title:this.metaDataHeader,closeAction:"hide",items:c,modal:!0,width:400,autoHeight:!0,bbar:["->",d,e,new Ext.Button({text:this.metadataFormCancelText,handler:function(){a.setValue(this.about.title);b.setValue(this.about["abstract"]);this.metadataForm.hide()},scope:this})]})},showMetadataForm:function(){this.metadataForm||this.initMetadataForm();this.metadataForm.show()},
updateURL:function(){return this.rest+this.mapID+"/data/"},save:function(a){var b=this.getState();!this.mapID||a?Ext.Ajax.request({url:this.rest,method:"POST",jsonData:b,success:function(a){a=a.getResponseHeader("Location");a=a.replace(/^\s*/,"");a=a.replace(/\s*$/,"");this.mapID=a=a.match(/[\d]*$/)[0];this.fireEvent("saved",a)},scope:this}):Ext.Ajax.request({url:this.updateURL(),method:"PUT",jsonData:b,success:function(){this.fireEvent("saved",this.mapID)},scope:this})},authenticate:function(a){var b=
function(){f.getForm().submit({waitMsg:"Logging in...",success:function(b,c){this.setAuthorizedRoles(["ROLE_ADMINISTRATOR"]);e.close();document.cookie=c.response.getResponseHeader("Set-Cookie");a&&Ext.Ajax.request(a)},failure:function(a){var b=a.items.get(0),a=a.items.get(1);b.markInvalid();a.markInvalid();b.focus(!0)},scope:this})}.createDelegate(this),c,d=document.cookie.match(/csrftoken=(\w+);/);d&&0<d.length&&(c=d[1]);var e=new Ext.Window({title:"GeoNode Login",modal:!0,width:230,autoHeight:!0,
layout:"fit",items:[{xtype:"form",autoHeight:!0,labelWidth:55,border:!1,bodyStyle:"padding: 10px;",url:"/accounts/ajax_login",waitMsgTarget:!0,errorReader:{read:function(a){return{success:200==a.status,records:[]}}},defaults:{anchor:"100%"},items:[{xtype:"textfield",name:"username",fieldLabel:"Username"},{xtype:"textfield",name:"password",fieldLabel:"Password",inputType:"password"},{xtype:"hidden",name:"csrfmiddlewaretoken",value:c},{xtype:"button",text:"Login",inputType:"submit",handler:b}]}],keys:{key:Ext.EventObject.ENTER,
fn:b}});e.show();var f=e.items.get(0);f.items.get(0).focus(!1,100)}});Ext.namespace("GeoExplorer");
GeoExplorer.Viewer=Ext.extend(GeoExplorer,{loadConfig:function(a){var b,c;for(c in a.sources){b=a.sources[c];if(!b.ptype||/wmsc?source/.test(b.ptype))b.forceLazy=!1===a.useCapabilities;if(!1===a.useToolbar){b=!0;for(var d,e=a.map.layers.length-1;0<=e;--e)d=a.map.layers[e],d.source==c&&(!1===d.visibility?a.map.layers.remove(d):b=!1);b&&delete a.sources[c]}}if(!1!==a.useToolbar)a.tools=(a.tools||[]).concat({ptype:"gxp_styler",id:"styler",rasterStyling:!0,actionTarget:void 0});GeoExplorer.superclass.loadConfig.apply(this,
arguments)},initPortal:function(){if(!1!==this.useToolbar)this.toolbar=new Ext.Toolbar({xtype:"toolbar",region:"north",autoHeight:!0,disabled:!0,items:this.createTools()}),this.on("ready",function(){this.toolbar.enable()},this);this.portalItems=[this.mapPanel];GeoExplorer.superclass.initPortal.apply(this,arguments)},addLayerSource:function(a){GeoExplorer.superclass.addLayerSource.apply(this,arguments)},createTools:function(){return[new Ext.Button({tooltip:"Layer Switcher",iconCls:"icon-layer-switcher",
menu:new gxp.menu.LayerMenu({layers:this.mapPanel.layers})})]}});Ext.namespace("GeoExplorer");
GeoExplorer.CapabilitiesRowExpander=Ext.extend(Ext.grid.RowExpander,{abstractText:"UT:Abstract:",attributionEmptyText:"UT: No attribution information is provided for this layer.",attributionText:"UT:Provided by:",downloadText:"UT:Download:",keywordEmptyText:"UT: No keywords are listed for this layer.",keywordText:"UT:Keywords:",metadataEmptyText:"UT: No metadata URLs are defined for this layer.",metadataText:"UT:Metadata Links:",ows:null,constructor:function(a){a=a||{};a.tpl=a.tpl||this.getDefaultTemplate();
var b,c;b=this;c=Ext.apply({ows:function(){return b.ows}},this.templateLibrary);c.metadataEmptyText=this.metadataEmptyText;c.keywordEmptyText=this.keywordEmptyText;c.attributionEmptyText=this.attributionEmptyText;Ext.apply(a.tpl,c);GeoExplorer.CapabilitiesRowExpander.superclass.constructor.call(this,a);this.on("beforeexpand",function(a,b,c){a=b.store;if(a instanceof GeoExt.data.WMSCapabilitiesStore){var g=a.reader.raw.capability.request.describelayer;g&&Ext.Ajax.request({url:g.href,params:{REQUEST:"DescribeLayer",
VERSION:a.reader.raw.version,LAYERS:b.get("layer").params.LAYERS},disableCaching:!1,success:function(a){a=(new OpenLayers.Format.WMSDescribeLayer).read(a.responseXML&&a.responseXML.documentElement?a.responseXML:a.responseText);a.length&&"WFS"===a[0].owsType&&Ext.get(Ext.query(".wfs.nodisplay",c)).removeClass("nodisplay")},failure:function(){},scope:this});return!0}},this)},getDefaultTemplate:function(){return new Ext.Template("<p><b>"+this.abstractText+"</b> {abstract}</p><p><b>"+this.attributionText+
"</b> {attribution:this.attributionLink}</p><p><b>"+this.metadataText+"</b> {metadataURLs:this.metadataLinks}</p><p><b>"+this.keywordText+'</b> {keywords:this.keywordList}</p><span class="{formats:this.showDownload}"><p><b>'+this.downloadText+'</b> <a class="download pdf" target="_blank" href="{name:this.pdfUrl}">PDF</a>, <a class="download kml" target="_blank" href="{name:this.kmlUrl}">KML</a>, <a class="download geotiff" target="_blank" href="{name:this.geoTiffUrl}">GeoTIFF</a><span class="wfs nodisplay">, <a class="download shp" target="_blank" href="{name:this.shpUrl}">SHP (ZIP)</a></span></p></span>')},
templateLibrary:{wmsParams:function(a,b,c){if(null!=b.llbbox){var c=c||8.5/11,d,e,f;d=(b.llbbox[2]-b.llbbox[0])/(b.llbbox[3]-b.llbbox[1]);f=e=1;d>c?f=d/c:e=c/d;return{service:"wms",request:"GetMap",bbox:this.adjustBounds(e,f,b.llbbox).toString(),layers:a,srs:"EPSG:4326",width:425,height:550}}},adjustBounds:function(a,b,c){var d,e,f;d=c[2]-c[0];e=c[3]-c[1];f=(c[2]+c[0])/2;c=(c[3]+c[1])/2;return[f-a*d/2,c-b*e/2,f+a*d/2,c+b*e/2]},wfsParams:function(a){return{service:"wfs",request:"GetFeature",typeName:a}},
showDownload:function(a){return a&&-1!==a.indexOf("application/vnd.google-earth.kmz+xml")&&-1!==a.indexOf("application/pdf")&&-1!==a.indexOf("image/geotiff")?"":"nodisplay"},shpUrl:function(a,b){var c=Ext.apply(this.wfsParams(a,b),{outputFormat:"SHAPE-ZIP"});return this.ows()+"?"+Ext.urlEncode(c)},pdfUrl:function(a,b){var c=Ext.apply(this.wmsParams(a,b),{format:"application/pdf"});return this.ows()+"?"+Ext.urlEncode(c)},kmlUrl:function(a,b){var c=Ext.apply(this.wmsParams(a,b),{format:"application/vnd.google-earth.kmz+xml",
height:2048,width:2048},1);return this.ows()+"?"+Ext.urlEncode(c)},geoTiffUrl:function(a,b){var c=Ext.apply(this.wmsParams(a,b),{format:"image/geotiff"});return this.ows()+"?"+Ext.urlEncode(c)},metadataLinks:function(a){if(null==a||0===a.length)return"<em>"+this.metadataEmptyText+"</em>";var b,c,d;c=[];for(b=0,d=a.length;b<d;b++)c.push('<a target="_blank" href="'+a[b].href+'"> '+a[b].type+"</a>");return c.join(", ")},keywordList:function(a){return null==a||0===a.length?"<em>"+this.keywordEmptyText+
"</em>":a.join(", ")},attributionLink:function(a){return null==a||null==a.href?"<em>"+this.attributionEmptyText+"</em>":'<a href="'+a.href+'"> '+a.title+"</a>"}}});Ext.ns("GeoExplorer.slider");
GeoExplorer.slider.FilledSlider=Ext.extend(Ext.slider.MultiSlider,{onRender:function(){this.autoEl={cls:"x-slider "+(this.vertical?"x-slider-vert":"x-slider-horz"),cn:{cls:"x-slider-end",cn:{cls:"x-slider-inner",cn:[{tag:"a",cls:"x-slider-focus",href:"#",tabIndex:"-1",hidefocus:"on"}]}}};Ext.slider.MultiSlider.superclass.onRender.apply(this,arguments);this.endEl=this.el.first();this.innerEl=this.endEl.first();this.focusEl=this.innerEl.child(".x-slider-focus");for(var a=0;a<this.thumbs.length;a++)this.thumbs[a].render();
a=this.innerEl.child(".x-slider-thumb");this.halfThumb=(this.vertical?a.getHeight():a.getWidth())/2;this.initEvents()},initEvents:function(){GeoExplorer.slider.FilledSlider.superclass.initEvents.call();this.on({change:this.onThumbChange,scope:this})},onThumbChange:function(){}});Ext.reg("app_fillslider",GeoExplorer.slider.FilledSlider);Ext.namespace("GeoExplorer.plugins");
GeoExplorer.plugins.LayerProperties=Ext.extend(gxp.plugins.LayerProperties,{ptype:"app_layerproperties",addOutput:function(a){var b=this.target.selectedLayer,c=b.getLayer();c.dimensions&&c.dimensions.time&&b.set("properties","app_timelayerpanel");GeoExplorer.plugins.LayerProperties.superclass.addOutput.call(this,a)}});Ext.preg(GeoExplorer.plugins.LayerProperties.prototype.ptype,GeoExplorer.plugins.LayerProperties);Ext.namespace("GeoExplorer.plugins");
GeoExplorer.plugins.Notes=Ext.extend(gxp.plugins.Tool,{ptype:"app_notes",errorTitle:"Error creating notes layer",iconCls:"gxp-icon-note",notesText:"Notes",showNotesText:"Show notes",featureEditor:null,layerNameTpl:null,layerName:null,createLayerUrl:null,params:null,workspacePrefix:null,onMapSave:function(a){if(null===this.layerName)this.layerName=this.getLayerName(a),Ext.Ajax.request({method:"POST",url:(new Ext.Template(this.createLayerUrl)).applyTemplate({mapID:a}),success:this.onLayerCreateSuccess,
scope:this})},setLayer:function(a){this.target.tools[this.featureEditor].getFeatureManager().setLayer(a);this.actions[0].enable()},setupLayer:function(){this.target.createLayerRecord({source:"local",title:this.notesText,bbox:this.target.mapPanel.map.maxExtent.toArray(),name:this.workspacePrefix+":"+this.layerName},this.setLayer,this)},onLayerCreateSuccess:function(a){if((a=Ext.decode(a.responseText))&&!0===a.success)this.setupLayer();else if(a.errors){for(var b="",c=0,d=a.errors.length;c<d;++c)b+=
a.errors[c]+"<br/>";Ext.Msg.show({title:this.errorTitle,msg:b,icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}},getLayerName:function(a){return(new Ext.Template(this.layerNameTpl)).applyTemplate({mapID:a})},addActions:function(){var a=this.target.mapID||this.target.id;if(a)this.layerName=this.getLayerName(a),this.target.mapPanel.on("afterlayeradd",this.setupLayer,this,{single:!0});else this.target.on({saved:this.onMapSave,scope:this});var b=this.target.tools[this.featureEditor],c=b.getFeatureManager();
c.featureLayer.events.on({visibilitychanged:function(a){Ext.getCmp(this.outputConfig.id).items.get(0).setChecked(a.object.getVisibility())},scope:this});return GeoExplorer.plugins.Notes.superclass.addActions.apply(this,[{tooltip:"Annotations - notes",disabled:!a,id:"notes-button",iconCls:this.iconCls,menu:new Ext.menu.Menu({id:this.outputConfig.id,items:[new Ext.menu.CheckItem({checked:c.featureLayer.getVisibility(),text:this.showNotesText,listeners:{checkchange:function(a,e){!0===e?c.showLayer(b.id,
b.showSelectedOnly&&"selected"):c.hideLayer(b.id)},scope:this}})]})}])}});Ext.preg(GeoExplorer.plugins.Notes.prototype.ptype,GeoExplorer.plugins.Notes);Ext.ns("GeoExplorer");
GeoExplorer.PlaybackToolbar=Ext.extend(gxp.PlaybackToolbar,{playbackMode:"ranged",prevTooltip:"Reverse One Frame",fullSizeTooltip:"Fullscreen",smallSizeTooltip:"Back to Smaller Size",legendTooltip:"Show Map Legend",editTooltip:"Edit This Map",watchTooltip:"Watch in MapStory",timelineTooltip:"Toggle Timeline",overlayNodeText:"Storylayers",legendOffsetY:55,initComponent:function(){if(!this.playbackActions)this.playbackActions=["play","slider","loop","fastforward","prev","next",{xtype:"tbspacer"},"legend",
"timeline",{xtype:"tbfill"},"settings",{xtype:"tbspacer"},"togglesize","edit","->","embedwatch"];this.defaults=Ext.applyIf(this.defaults||{},{scale:"large"});if(-1<this.playbackActions.indexOf("legend"))this.layerManager=this.addLayerManager();this.aggressive=null===window.location.href.match(/view|new/);app.on("togglesize",function(a){null!==app.id&&this.toggleLegend(null,a);this.setToggleButton(a)},this);this.on("afterlayout",function(){null!==app.id&&this.toggleLegend(null,app.fullScreen);this.setToggleButton(app.fullScreen);
this.btnEdit&&(app.fullScreen&&app.isAuthorized()?this.btnEdit.show():this.btnEdit.hide());this.btnTimeline&&(app.fullScreen||app.embed?this.btnTimeline.show():this.btnTimeline.hide());this.btnWatch&&app.embed&&this.btnWatch.show()},this,{delay:400});app.portal.on("resize",function(a){this.resizeLegend(a.lastSize.height)},this,{delay:400});GeoExplorer.PlaybackToolbar.superclass.initComponent.call(this)},getAvailableTools:function(){var a=GeoExplorer.PlaybackToolbar.superclass.getAvailableTools.call(this);
Ext.apply(a,{modegroup:{xtype:"buttongroup",columns:3,defaults:{handler:this.toggleModes,toggleGroup:"playback_mode",enableToggle:!0},items:[{text:"R",pressed:"ranged"===this.playbackMode},{text:"C",pressed:"cumulative"===this.playbackMode},{text:"S",pressed:"track"===this.playbackMode}]},togglesize:{iconCls:"gxp-icon-fullScreen",toggleHandler:this.toggleMapSize,hidden:null===this.layerManager||!0===app.embed,ref:"btnToggle",enableToggle:!0,allowDepress:!0,scope:this},legend:{iconCls:"gxp-icon-legend",
hidden:null===this.layerManager,pressed:app.fullScreen,ref:"btnLegend",toggleHandler:this.toggleLegend,tooltip:this.legendTooltip,enableToggle:!0,scope:this},prev:{iconCls:"gxp-icon-prev",handler:this.reverseStep,scope:this,tooltip:this.prevTooltip},edit:{iconCls:"gxp-icon-editMap",handler:this.loadComposser,hidden:!0,scope:this,ref:"btnEdit",tooltip:this.editTooltip,disabled:null!==window.location.href.match(/view|new/)},timeline:{iconCls:"ms-icon-timeline-white",enableToggle:!0,handler:function(){Ext.getCmp("timeline-container").toggleCollapse()},
hidden:!0,tooltip:this.timelineTooltip,ref:"btnTimeline"},embedwatch:{iconCls:"ms-icon-watch",hidden:!0,tooltip:this.watchTooltip,handler:function(){var a=window.location.href.replace("embed","");window.open(a)},ref:"btnWatch"}});return a},buildPlaybackItems:function(){return GeoExplorer.PlaybackToolbar.superclass.buildPlaybackItems.call(this)},setToggleButton:function(a){var b=this.btnToggle;a?(b.btnEl.removeClass("gxp-icon-fullScreen"),b.btnEl.addClass("gxp-icon-smallScreen")):(b.btnEl.removeClass("gxp-icon-smallScreen"),
b.btnEl.addClass("gxp-icon-fullScreen"));b.removeClass("x-btn-pressed")},toggleMapSize:function(a){app.fullScreen?app.setMinMapSize():app.setMaxMapSize();a.el.removeClass("x-btn-pressed")},toggleLegend:function(a,b){var c=!0;if(void 0===this.layerPanel)this.layerPanel=this.buildLayerPanel();null!==this.layerPanel&&(b?(this.layerPanel.show(),this.resizeLegend(app.mapPanel.getHeight())):(c=!1,this.layerPanel.hide()),void 0!==this.btnLegend&&this.btnLegend.toggle(c,!0))},resizeLegend:function(a){this.layerPanel&&
(this.layerPanel.el.setStyle("max-height",a-this.legendOffsetY+"px"),this.layerPanel.el.setStyle("overflow-y","auto"),this.layerPanel.el.alignTo(app.mapPanel.el,"br-br",[-7,-35]),this.layerPanel.doLayout())},buildLayerPanel:function(){if(null!==this.layerManager){var a=this.layerManager.output[0];a.el.anchorTo(app.mapPanel.el,"br-br",[-7,-35]);return a}return null},reverseStep:function(){var a=this.control;a.stop();a.step*=-1;a.tick();a.step*=-1},loadComposser:function(){var a=window.location.href.split("#")[0];
a.endsWith('/')?a=a+"view":a=a+"/view"; window.location.href=a},addLayerManager:function(){for(var a in app.tools)if("gxp_layermanager"===app.tools[a].ptype)return null;a={collapse:function(){this.resizeLegend(app.mapPanel.getHeight())},expand:function(){this.resizeLegend(app.mapPanel.getHeight())},scope:this};a=new gxp.plugins.LayerManager({id:"layermanager-tool",outputTarget:"map",loader:{baseAttrs:{baseParams:{legend_options:"fontAntiAliasing:true;fontSize:11;fontName:Arial;fontColor:#FFA500;fontStyle:bold"}}},groups:{"default":{title:this.overlayNodeText,
listeners:a},background:{title:"Base Maps",exclusive:!0,expanded:!1,listeners:a}},outputConfig:{hidden:!1,layout:"fit",plain:!0,autoScroll:!0,border:!1,floating:!0,padding:5,shadow:!1}});a.init(app);a.addOutput();return a}});Ext.reg("app_playbacktoolbar",GeoExplorer.PlaybackToolbar);Ext.namespace("GeoExplorer");
GeoExplorer.TimeLayerPanel=Ext.extend(gxp.WMSLayerPanel,{layerPlaybackFieldText:"Add extra playback options",playbackModeFieldText:"Playback Mode",initComponent:function(){var a=app.portal.findByType("gxp_playbacktoolbar"),a=a.length?a[0]:app.tools["playback-tool"].playbackToolbar,b=a.control;b||(b=app.mapPanel.map.getControlsByClass("OpenLayers.Control.DimensionManager")[0]);this.playbackToolbar=a;this.timeManager=b;GeoExplorer.TimeLayerPanel.superclass.initComponent.call(this)},createDisplayPanel:function(){var a=
GeoExplorer.TimeLayerPanel.superclass.createDisplayPanel.call(this);a.items.push({xtype:"checkbox",ref:"../playbackCheck",boxLabel:this.layerPlaybackFieldText,checked:this.checkLayerPlaybackMode(),listeners:{check:this.toggleLayerPlaybackMode,scope:this}},{fieldLabel:this.playbackModeFieldText,xtype:"gxp_playbackmodecombo",ref:"../playbackModeCombo",anchor:"-5",disabled:!this.checkLayerPlaybackMode(),value:this.getLayerPlaybackMode(),listeners:{beforemodechange:this.attachAgentToCombo,modechange:this.setPlaybackMode,
scope:this}});return a},attachAgentToCombo:function(){var a=this.playbackModeCombo,b=this.layerRecord.getLayer();if(!a.agents||!a.agents.length)a.agents=[this.splitManagerAgents(b,this.timeManager)]},toggleLayerPlaybackMode:function(a,b){var c=a.refOwner.playbackModeCombo;b&&this.attachAgentToCombo();c.setDisabled(!b)},setPlaybackMode:function(a,b){if(!this.playbackToolbar.playbackMode)this.playbackToolbar.playbackMode="track";switch(b){case "cumulative":"track"==this.playbackToolbar.playbackMode&&
this.playbackToolbar.setPlaybackMode("cumulative");break;case "range":"ranged"!=this.playbackToolbar.playbackMode&&this.playbackToolbar.setPlaybackMode("ranged")}},splitManagerAgents:function(a,b){b.removeAgentLayer(a);var c=b.buildAgents(a)[0];b.agents.push(c);return c},getLayerPlaybackMode:function(){this._agent||this.getLayerAgent();var a=this._agent;return a&&a.tickMode},checkLayerPlaybackMode:function(){this._agent||this.getLayerAgent();var a=this._agent,b=this.playbackToolbar,c=!1;if(a&&b)switch(a.tickMode){case "range":c=
"ranged"!=b.playbackMode;break;case "cumulative":c="cumulative"!=b.playbackMode;break;default:c="track"!=b.playbackMode}return c},getLayerAgent:function(a,b){for(var a=a||this.layerRecord.getLayer(),c=b&&b.agents||this.timeManager.agents||[],d=0;d<c.length;d++)if(-1<c[d].layers.indexOf(a))return this._agent=c[d],c[d];return null}});Ext.reg("app_timelayerpanel",GeoExplorer.TimeLayerPanel);Ext.namespace("GeoNode");
GeoNode.BatchDownloadWidget=Ext.extend(Ext.util.Observable,{downloadingText:"UT: Downloading...",cancelText:"UT: Cancel",windowMessageText:"UT: Please wait",constructor:function(a){Ext.apply(this,a);this.beginDownload()},beginDownload:function(){var a=this;Ext.Ajax.request({url:this.begin_download_url,method:"POST",params:{layer:this.layers,format:this.format},success:function(b){b=Ext.util.JSON.decode(b.responseText);a.monitorDownload(b.id)}})},monitorDownload:function(a){var b,c=this,d=new Ext.ProgressBar({text:this.downloadingText}),
e=function(){Ext.Ajax.request({url:c.stop_download_url+a,method:"GET",success:function(){clearInterval(b)},failure:function(){clearInterval(b)}})},f=new Ext.Window({width:250,height:100,plain:!0,modal:!0,closable:!1,hideBorders:!0,items:[d],buttons:[{text:this.cancelText,handler:function(){e();f.hide()}}]});b=setInterval(function(){Ext.Ajax.request({url:c.begin_download_url+"?id="+a,method:"GET",success:function(e){e=Ext.util.JSON.decode(e.responseText);"FINISHED"===e.process.status?(clearInterval(b),
d.updateProgress(1,"Done....",!0),f.close(),location.href=c.download_url+a):d.updateProgress(e.process.progress/100,c.downloadingText,!0)},failure:function(){clearInterval(b);f.close()}})},1E3);f.show()}});Ext.namespace("GeoNode");
GeoNode.BoundingBoxWidget=Ext.extend(Ext.util.Observable,{viewerConfig:null,constructor:function(a){Ext.apply(this,a);this.doLayout()},doLayout:function(){var a=Ext.get(this.renderTo),b={proxy:this.proxy,useCapabilities:!1,useBackgroundCapabilities:!1,useToolbar:!1,useMapOverlay:!1,portalConfig:{collapsed:!0,border:!1,height:300,renderTo:a.query(".bbox-expand")[0]},listeners:{ready:function(){this._ready=!0},scope:this}},b=Ext.apply(b,this.viewerConfig);this.viewer=new GeoExplorer.Viewer(b);this.enabledCB=
a.query(".bbox-enabled input")[0];this.disable();Ext.get(this.enabledCB).on("click",function(){!0==this.enabledCB.checked?this.enable():this.disable()},this)},isActive:function(){return!0==this.enabledCB.checked},hasConstraint:function(){return this.isActive()},applyConstraint:function(a){if(this.hasConstraint()){var b=this.viewer.mapPanel.map.getExtent();b.transform(new OpenLayers.Projection(this.viewerConfig.map.projection),new OpenLayers.Projection("EPSG:4326"));a.bbox=b.toBBOX()}else this._ready&&
delete a.bbox},initFromQuery:function(a,b){if(b.bbox){var c=OpenLayers.Bounds.fromString(b.bbox);if(c){c.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection(this.viewerConfig.map.projection));var d=function(){var a=this.viewer.mapPanel.map;a.events.register("moveend",this,function(){a.events.unregister("moveend",this,arguments.callee);a.zoomToExtent(c,!0)});this.enable()};if(this._ready)d.call(this);else this.viewer.on("ready",d,this)}}},enable:function(){this.enabledCB.checked=
!0;this.viewer.portal&&this.viewer.portal.expand()},disable:function(){this.enabledCB.checked=!1;this.viewer.portal&&this.viewer.portal.collapse()}});Ext.namespace("GeoNode");
GeoNode.DataCart=Ext.extend(Ext.util.Observable,{selectedLayersText:"UT: Selected Layers",emptySelectionText:"UT: No Layers Selected",titleText:"UT: Title",clearSelectedButtonText:"UT: Clear Selected",clearAllButtonText:"UT: Clear All",constructor:function(a){Ext.apply(this,a);this.doLayout()},getSelectedLayerIds:function(){var a=[];this.grid.selModel.each(function(b){a.push(b.get("name"))});return a},doLayout:function(){var a=Ext.get(this.renderTo);a.update('<div class="selection-table"></div><div class="selection-controls"></div><div class="selection-ops></div>"');
var b=a.query(".selection-controls")[0],c=a.query(".selection-table")[0];a.query(".selection-ops");var d=new Ext.grid.CheckboxSelectionModel({});this.grid=new Ext.grid.GridPanel({store:this.store,viewConfig:{autoFill:!0,forceFit:!0,emptyText:this.emptySelectionText,deferEmptyText:!1},height:150,renderTo:c,selModel:d,hideHeaders:!0,colModel:new Ext.grid.ColumnModel({defaults:{sortable:!1,menuDisabled:!0},columns:[d,{dataIndex:"title"}]})});this.store.on("add",function(a,b,c){d.selectRow(c,!0)});a=
new Ext.Button({text:this.clearSelectedButtonText});a.on("click",function(){d.each(function(a){a=this.store.indexOfId(a.id);0<=a&&this.store.removeAt(a)},this);this.store.reselect()},this);c=new Ext.Button({text:this.clearAllButtonText});c.on("click",function(){this.store.removeAll();this.store.reselect()},this);(new Ext.Panel({frame:!1,border:!1,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:0}}),items:[a,c]})).render(b)}});Ext.namespace("GeoNode");
GeoNode.DataCartOps=Ext.extend(Ext.util.Observable,{failureText:"UT: Operation Failed",noLayersText:"UT: No layers are currently selected.",constructor:function(a){Ext.apply(this,a);this.doLayout()},doLayout:function(){var a=Ext.get(this.renderTo),b=Ext.get(a.query("a.create-map")[0]);this.createMapForm=Ext.get(a.query("#create_map_form")[0]);b.on("click",function(a){a.preventDefault();(a=this.cart.getSelectedLayerIds())&&a.length?this.createNewMap(a):Ext.MessageBox.alert(this.failureText,this.noLayersText)},
this);batch_links=a.query("a.batch-download");for(a=0;a<batch_links.length;a++)Ext.get(batch_links[a]).on("click",function(a,b){a.preventDefault();var e=this.cart.getSelectedLayerIds();if(e&&e.length){var f=Ext.get(b).getAttribute("href").substr(1);this.batchDownload(e,f)}else Ext.MessageBox.alert(this.failureText,this.noLayersText)},this)},createNewMap:function(a){for(var b=[],c=0;c<a.length;c++)b.push({tag:"input",type:"hidden",name:"layer",value:a[c]});b.push({tag:"input",type:"hidden",name:"csrfmiddlewaretoken",
value:Ext.util.Cookies.get("csrftoken")});Ext.DomHelper.overwrite(this.createMapForm,{tag:"div",cn:b});this.createMapForm.dom.submit()},batchDownload:function(a,b){new GeoNode.BatchDownloadWidget({layers:a,format:b,begin_download_url:this.begin_download_url,stop_download_url:this.stop_download_url,download_url:this.download_url})}});Ext.namespace("GeoNode");
GeoNode.DataCartStore=Ext.extend(Ext.data.Store,{constructor:function(a){this.selModel=a.selModel;this.reselecting=!1;this.selModel.on("rowselect",function(a,c,d){!0!=this.reselecting&&-1==this.indexOfId(d.id)&&this.add([d])},this);this.selModel.on("rowdeselect",function(a,c,d){!0!=this.reselecting&&(c=this.indexOfId(d.id),-1!=c&&this.removeAt(c))},this);GeoNode.DataCartStore.superclass.constructor.call(this,a)},reselect:function(){this.reselecting=!0;this.selModel.clearSelections();var a=this.selModel.grid.store;
this.each(function(b){b=a.indexOfId(b.id);-1!=b&&this.selModel.selectRow(b,!0);return!0},this);this.reselecting=!1}});Ext.namespace("GeoNode");
GeoNode.MapSearchTable=Ext.extend(Ext.util.Observable,{autoExpandColumn:"title",titleHeaderText:"UT: Title",contactHeaderText:"UT: Contact",lastModifiedHeaderText:"UT: Last Modified",mapAbstractLabelText:"UT: Abstract",mapLinkLabelText:"UT:View this Map",previousText:"UT: Prev",nextText:"UT: Next",ofText:"UT: of",noResultsText:"UT: Your search did not match any items.",searchLabelText:"UT: Search Maps",searchButtonText:"UT: Search",showingText:"UT: Showing",loadingText:"UT: Loading",permalinkText:"UT: permalink",
constructor:function(a){this.addEvents("load");Ext.apply(this,a);this.initFromQuery();this.loadData()},loadData:function(){this.searchStore=new Ext.data.JsonStore({url:this.searchURL,root:"rows",idProperty:"name",remoteSort:!0,totalProperty:"total",fields:[{name:"id",mapping:"id"},{name:"title",type:"string"},{name:"abstract",type:"string"},{name:"detail",type:"string"},{name:"owner",type:"string"},{name:"owner_detail",type:"string"},{name:"last_modified",type:"string"}]});this.searchStore.on("load",
function(){this.updateControls();this.fireEvent("load",this)},this);this.doLayout();this.doSearch()},initFromQuery:function(){if(!this.searchParams)this.searchParams={};if(!this.searchParams.start)this.searchParams.start=0;if(!this.searchParams.limit)this.searchParams.limit=25;if(this.constraints)for(var a=0;a<this.constraints.length;a++)this.constraints[a].initFromQuery(this,this.searchParams)},doSearch:function(){this.searchParams.start=0;if(this.constraints)for(var a=0;a<this.constraints.length;a++)this.constraints[a].applyConstraint(this.searchParams);
this._search(this.searchParams)},_search:function(a){this.disableControls();this.searchStore.load({params:a});this.updatePermalink(a)},loadNextBatch:function(){this.searchParams.start+=this.searchParams.limit;this._search(this.searchParams)},loadPrevBatch:function(){this.searchParams.start-=this.searchParams.limit;if(0>this.searchParams.start)this.searchParams.start=0;this._search(this.searchParams)},disableControls:function(){this.nextButton.setDisabled(!0);this.prevButton.setDisabled(!0);this.pagerLabel.setText(this.loadingText)},
updateControls:function(){var a=this.searchStore.getTotalCount();0<this.searchParams.start?this.prevButton.setDisabled(!1):this.prevButton.setDisabled(!0);this.searchParams.start+this.searchParams.limit<a?this.nextButton.setDisabled(!1):this.nextButton.setDisabled(!0);var b=this.searchParams.start+1,c=b+this.searchParams.limit-1;c>a&&(c=a);this.pagerLabel.setText(this.showingText+" "+b+"-"+c+" "+this.ofText+" "+a)},updatePermalink:function(){if(this.permalink)this.permalink.href=Ext.urlAppend(this.permalinkURL,
Ext.urlEncode(this.searchParams))},updateQuery:function(){this.searchParams.q=this.queryInput.getValue();this.doSearch()},hookupSearchButtons:function(a){for(var a=Ext.get(a).query(".search-button"),b=0;b<a.length;b++){var c=a[b].innerHTML||this.searchButtonText;Ext.get(a[b]).update("");(new Ext.Button({text:c,renderTo:a[b]})).on("click",this.doSearch,this)}},doLayout:function(){var a=Ext.get(this.renderTo);a.update('<div class="search-results"><div class="search-input"></div><div class="search-table"></div><div class="search-controls"></div></div>');
var b=a.query(".search-input")[0],c=a.query(".search-table")[0],a=a.query(".search-controls")[0],d=new Ext.Template("<p><b>"+this.mapAbstractLabelText+':</b> {abstract}</p><p><a href="/maps/{id}">'+this.mapLinkLabelText+"</a></p>"),e=new Ext.grid.RowExpander({tpl:d});e.on("expand",function(a,b,c){Ext.select("a",Ext.get(c)).on("click",function(a){a.stopPropagation()})});tableCfg={store:this.searchStore,plugins:[e],autoExpandColumn:"title",viewConfig:{autoFill:!0,forceFit:!0,emptyText:this.noResultsText,
listeners:{refresh:function(a){Ext.select("a",Ext.get(a.mainBody)).on("click",function(a){a.stopPropagation()})},rowsinserted:function(a,b,c){for(;b<c;b++)Ext.select("a",Ext.get(a.getRow(b))).on("click",function(a){a.stopPropagation()})},rowupdated:function(a,b){Ext.select("a",Ext.get(a.getRow(b))).on("click",function(a){a.stopPropagation()})}}},autoHeight:!0,renderTo:c,listeners:{rowdblclick:function(a,b){var c=a.store.getAt(b);if(null!=c)location.href=c.get("detail")},rowclick:function(a,b){e.toggleRow(b)},
beforerender:function(a){a.on("render",function(){a.getView().mainBody.un("mousedown",e.onMouseDown,e)})}}};c=new Ext.grid.ColumnModel({defaults:{menuDisabled:!0,sortable:!0},columns:[e,{header:this.titleHeaderText,dataIndex:"title",id:"title",renderer:function(a,b,c){return(b=c.get("detail"))?'<a href="'+b+'">'+a+"</a>":a}},{header:this.contactHeaderText,dataIndex:"owner",id:"owner",renderer:function(a,b,c){return(b=c.get("owner_detail"))?'<a href="'+b+'">'+a+"</a>":a}},{header:this.lastModifiedHeaderText,
dataIndex:"last_modified",id:"last_modified",renderer:function(a){dt=Date.parseDate(a,"c");return dt.format("F j, Y")}}]});tableCfg.colModel=c;this.table=new Ext.grid.GridPanel(tableCfg);this.queryInput=new Ext.form.TextField({fieldLabel:this.searchLabelText,name:"search",allowBlank:!0,width:350});this.queryInput.on("specialkey",function(a,b){b.getKey()==b.ENTER&&this.updateQuery()},this);c=new Ext.Button({text:this.searchButtonText});c.on("click",this.updateQuery,this);(new Ext.Panel({frame:!1,border:!1,
layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),items:[this.queryInput,c]})).render(b);this.prevButton=new Ext.Button({text:this.previousText});this.prevButton.on("click",this.loadPrevBatch,this);this.nextButton=new Ext.Button({text:this.nextText});this.nextButton.on("click",this.loadNextBatch,this);this.pagerLabel=new Ext.form.Label({text:""});(new Ext.Panel({frame:!1,border:!1,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),
items:[this.prevButton,this.nextButton,this.pagerLabel]})).render(a);this.permalink=Ext.query("a.permalink")[0];this.disableControls();this.searchParams.q&&this.queryInput.setValue(this.searchParams.q);this.updatePermalink()}});Ext.namespace("GeoNode");
GeoNode.SearchTableRowExpander=Ext.extend(Ext.grid.RowExpander,{errorText:"UT: Unable to fetch layer details.",loadingText:"UT: Loading...",constructor:function(a){this.fetchURL=a.fetchURL;GeoNode.SearchTableRowExpander.superclass.constructor.call(this,a)},getRowClass:function(a,b,c){c.cols-=1;return this.state[a.id]?"x-grid3-row-expanded":"x-grid3-row-collapsed"},fetchBodyContent:function(a,b,c){this.enableCaching||this._fetchBodyContent(a,b,c);var d=this.bodyContent[b.id];d?a.innerHTML=d:this._fetchBodyContent(a,
b,c)},_fetchBodyContent:function(a,b){a.innerHTML=this.loadingText;var c=this.fetchURL+"?uuid="+b.get("uuid"),d=this;Ext.Ajax.request({url:c,method:"GET",success:function(c){c=c.responseText;a.innerHTML=c;d.bodyContent[b.id]=c},failure:function(){a.innerHTML=d.errorText}})},beforeExpand:function(a,b,c){return!1!==this.fireEvent("beforeexpand",this,a,b,c)?(this.fetchBodyContent(b,a,c),!0):!1}});Ext.namespace("GeoNode");
GeoNode.UserSelector=Ext.extend(Ext.util.Observable,{constructor:function(a){Ext.apply(this,a);this.initUserStore();this.panel=this.doLayout()},initUserStore:function(){if(!this.userstore){var a={proxy:new Ext.data.HttpProxy({url:this.userLookup,method:"POST"}),reader:new Ext.data.JsonReader({root:"users",totalProperty:"count",fields:[{name:"username"}]})};Ext.apply(a,this.availableUserConfig||{});this.userstore=new Ext.data.Store(a);this.userstore.load({params:{query:""}})}if(!this.store)this.store=
new Ext.data.ArrayStore({idIndex:0,fields:["username"],data:[]})},doLayout:function(){function a(){var a=this.availableUsers.getValue(),b=this.availableUsers.store.findExact("username",a);-1!=b&&-1==this.selectedUsers.store.findExact("username",a)&&(this.selectedUsers.store.add([this.availableUsers.store.getAt(b)]),this.availableUsers.reset())}var b=this.owner,c=function(){function a(){f.getEl().on("mousedown",c,this,{delegate:"button"})}function c(a,d){var e=f.findItemFromChild(d),j=f.indexOf(e);
f.store.getAt(j).get("username")!==b&&f.store.removeAt(f.indexOf(e))}var f;return{init:function(b){f=b;f.on("render",a)}}}();this.selectedUsers=new Ext.DataView({store:this.store,itemSelector:"div.user_item",tpl:new Ext.XTemplate('<div><tpl for="."> <div class="x-btn user_item"><button class="icon-removeuser remove-button">&nbsp;</button>{username}</div></tpl></div>'),plugins:[c],autoHeight:!0,multiSelect:!0});this.addButton=new Ext.Button({iconCls:"icon-adduser",handler:a,scope:this});this.availableUsers=
new Ext.form.ComboBox({width:180,store:this.userstore,typeAhead:!0,minChars:0,align:"right",border:"false",displayField:"username",emptyText:gettext("Add user..."),listeners:{scope:this,select:a}});return new Ext.Panel({border:!1,renderTo:this.renderTo,items:[this.selectedUsers,{layout:"hbox",border:!1,items:[this.addButton,this.availableUsers]}]})},setDisabled:function(a){this.selectedUsers.setDisabled(a);this.availableUsers.setDisabled(a);this.addButton.setDisabled(a)}});
Ext.override(Ext.dd.DragTracker,{onMouseMove:function(a){if(this.active&&Ext.isIE&&!Ext.isIE9&&!a.browserEvent.button)a.preventDefault(),this.onMouseUp(a);else{a.preventDefault();var b=a.getXY(),c=this.startXY;this.lastXY=b;if(!this.active)if(Math.abs(c[0]-b[0])>this.tolerance||Math.abs(c[1]-b[1])>this.tolerance)this.triggerStart(a);else return;this.fireEvent("mousemove",this,a);this.onDrag(a);this.fireEvent("drag",this,a)}}});
var GeonodeViewer=Ext.extend(gxp.Viewer,{localGeoServerBaseUrl:"",cachedSourceMatch:/mapstory\.dev|mapstory\.org/,cachedSubdomains:["t1","t2","t3","t4"],useMapOverlay:null,toggleGroup:"map",mapPanel:null,modified:0,popupCache:null,urlPortRegEx:/^(http[s]?:\/\/[^:]*)(:80|:443)?\//,fullScreen:!1,backgroundContainerText:"UT:Background",connErrorTitleText:"Communication error",connErrorText:"The mapping server did not respond properly. It is likely temporarily down, but should be up soon. If this problem persists please let the administrators know.",
connErrorDetailsText:"Details...",layerContainerText:"UT:Map Layers",saveFailMessage:"UT: Sorry, your map could not be saved.",saveFailTitle:"UT: Error While Saving",saveMapText:"UT: Save Map",saveMapAsText:"UT: Save Map As",saveNotAuthorizedMessage:"UT: You Must be logged in to save this map.",sourceLoadFailureMessage:"UT: Error contacting server.\n Please check the url and try again.",unknownMapMessage:"UT: The map that you are trying to load does not exist.  Creating a new map instead.",unknownMapTitle:"UT: Unknown Map",
constructor:function(a){a=a||{};this.popupCache={};this.addEvents("saved","beforeunload","togglesize");this.addConnectionHandlers();this.registerColorManager();this.on("portalready",function(){!0!==this.embed&&this.toggleMapSizeViaUrl();!0===this.embed&&(Ext.getCmp("timeline-container").show(),this.portal.doLayout());if(void 0!==window.onhashchange&&!0!==this.embed)window.onhashchange=Ext.createDelegate(this.toggleMapSizeViaUrl,this);Ext.EventManager.onWindowResize(function(){this.fullScreen&&!0!==
this.embed&&this.expandMap()},this)});Ext.form.ComboBox.prototype.getListParent=function(){return this.el.up(".x-window")||document.body};Ext.Window.prototype.shadow=!1;GeonodeViewer.superclass.constructor.apply(this,[a])},toggleMapSizeViaUrl:function(){"#full"===window.location.hash?this.setMaxMapSize():this.setMinMapSize()},setHashUrl:function(a){if(window.location.hash!==a)window.location.hash=a},expandMap:function(){var a=$('.navbar').height(),b=Ext.get("wrap"),
c=window.innerWidth,a=window.innerHeight-a+2;if(!this.portal.originalSize)this.portal.originalSize=this.portal.getSize();this.portal.setSize(c,a);this.portal.el.alignTo(b,"tl-tl",[0,parseInt($('#wrap').css('paddingTop'))])},setMaxMapSize:function(){this.expandMap();this.portal.el.setStyle({"z-index":999});Ext.getBody().setStyle({overflow:"hidden"});this.id&&Ext.getCmp("timeline-container").show();window.scrollTo(0,0);this.setHashUrl("#full");Ext.getBody().addClass("ms-fullscreen");this.fullScreen=!0;this.fireEvent("togglesize",
this.fullScreen,this.isAuthorized())},setMinMapSize:function(){this.portal.setSize(this.portal.originalSize);this.portal.setPosition(0,0);this.mapPanel.removeClass("full-mapview");Ext.getBody().setStyle({overflow:""});this.id&&Ext.getCmp("timeline-container").hide();this.setHashUrl("");this.fullScreen=!1;Ext.getBody().removeClass("ms-fullscreen");this.fireEvent("togglesize",this.fullScreen,this.isAuthorized())},loadConfig:function(a,b){var c=a&&(a.tools||a.sources||a.map),a=Ext.apply(a||{},{proxy:"/proxy/?url=",
rest:"/maps/"});c?b.call(this,a):Ext.Ajax.request({url:window.location.href.split("?")[0].replace(/\/view|\/embed|(\/new)|([0-9])$/,"$1$2/data"),success:function(c){c=Ext.decode(c.responseText,!0);Ext.apply(a,c);this.mapID=a.id;b.call(this,a)},scope:this})},applyConfig:function(a){var b=this.getDefaultTools(a,this.toggleGroup);b.push({ptype:"ms-tool-bar",suppressOutput:!0});var c=a.tools||[],d=Ext.pluck(a.tools,"ptype");a.tools=[];Ext.each(b,function(b){var f=d.indexOf(b.ptype);-1!=f&&(f=c[f],delete f.outputTarget,
b=Ext.apply(b,f));a.tools.push(b)});GeonodeViewer.superclass.applyConfig.call(this,a)},getDefaultTools:function(a){return a.tools||[]},initMapPanel:function(){var a=[new OpenLayers.Control.Attribution,new OpenLayers.Control.Zoom,new OpenLayers.Control.Navigation];this.initialConfig.map?this.initialConfig.map.controls=(this.initialConfig.map.controls||[]).concat(a):this.initialConfig.map={controls:a};GeonodeViewer.superclass.initMapPanel.call(this);this.mapPanel.layers.on({add:function(a,c){for(var d,
e=5<a.queryBy(function(a){a=a.getLayer();return a.dimensions&&a.dimensions.time&&a instanceof OpenLayers.Layer.Grid}).getCount(),f=c.length-1;0<=f;f--)if(d=c[f].getLayer(),!d.isBaseLayer&&d instanceof OpenLayers.Layer.Grid){d.addOptions({singleTile:e,transitionEffect:"resize"});var g=d.url;if(Ext.isString(g)&&("/"===g.charAt(0)&&-1!==g.indexOf("geoserver")&&g.replace("/geoserver/",this.localGeoServerBaseUrl),-1<g.search(this.cachedSourceMatch)&&this.cachedSubdomains)){for(var h=g.split("://"),i=[],
j=0,k=h.slice(-1)[0],l=this.cachedSubdomains.length;j<l;j++)i.push((1<h.length?h[0]+"://":"")+this.cachedSubdomains[j]+"."+k);d.url=i.concat([g])}if(d.params)d.params.TILED=!0}},scope:this})},initPortal:function(){this.on("ready",function(){this.mapPanel.map.events.on({changelayer:function(a){var b=a.layer;"params"===a.property&&!0===b.params.TILED&&(Ext.get(b.div).addClass("fade-all"),b.events.register("loadend",this,function d(){b.events.unregister("loadend",this,d);Ext.get(b.div).removeClass("fade-all")}))}});
this.mapPanel.layers.on({update:function(){this.modified|=1},add:function(){this.modified|=1},remove:function(){this.modified|=1},scope:this})});this.on("ready",this.loadLayerSources,this);Lang.registerLinks();GeonodeViewer.superclass.initPortal.call(this)},updateURL:function(){return this.rest+this.mapID+"/data"},save:function(a){var b=this.getState();!this.mapID||a?Ext.Ajax.request({url:this.rest,method:"POST",jsonData:b,success:function(a){a=a.getResponseHeader("Location");a=a.replace(/^\s*/,"");
a=a.replace(/\s*$/,"");this.mapID=a=a.match(/[\d]*$/)[0];this.fireEvent("saved",a)},scope:this}):Ext.Ajax.request({url:this.updateURL(),method:"PUT",jsonData:b,success:function(){this.fireEvent("saved",this.mapID)},scope:this})},addConnectionHandlers:function(){Ext.util.Observable.observeClass(Ext.data.Connection);Ext.data.Connection.on({beforerequest:function(a,b){var c=b.url instanceof Array?b.url.slice():[b.url];b.url=[];for(var d=c.length-1;0<=d;d--){var e=c[d].replace(this.urlPortRegEx,"$1/");
if(this.localGeoServerBaseUrl){if(0==e.indexOf(this.localGeoServerBaseUrl)){b.url.push(e.replace(RegExp("^"+this.localGeoServerBaseUrl),"/geoserver/"));return}var f=this.localGeoServerBaseUrl.replace(this.urlPortRegEx,"$1/");if(0===e.indexOf(f+"rest/")){b.url.push(e.replace(RegExp("^"+f),"/geoserver/"));return}}this.proxy&&0!==e.indexOf(this.proxy)&&0===e.indexOf(window.location.protocol)&&(e=e.replace(/&$/,"").split("?"),f=Ext.apply(e[1]&&Ext.urlDecode(e[1])||{},b.params),e=Ext.urlAppend(e[0],Ext.urlEncode(f)),
delete b.params,b.url.push(this.proxy+encodeURIComponent(e)))}if(!b.url.length)b.url=1==c.length?c[0]:c},requestexception:function(a,b,c){if(!c.failure)if(a=c.url,401==b.status&&a.indexOf("http"!=0)&&-1===a.indexOf(this.proxy)){var d;(b=document.cookie.match(/csrftoken=(\w+);/))&&0<b.length&&(d=b[1]);this.showLoginForm(d)}else 405!=b.status&&"/geoserver/rest/styles"!=a&&this.displayXHRTrouble(b)},scope:this})},registerColorManager:function(){Ext.util.Observable.observeClass(gxp.form.ColorField);gxp.form.ColorField.on({render:function(a){(new Styler.ColorManager).register(a)}})},
showLoginForm:function(a){var b=function(){d.getForm().submit({waitMsg:"Logging in...",success:function(a,b){this.setAuthorizedRoles(["ROLE_ADMINISTRATOR"]);c.close();document.cookie=b.response.getResponseHeader("Set-Cookie");Ext.Ajax.request(options)},failure:function(a){var b=a.items.get(0),a=a.items.get(1);b.markInvalid();a.markInvalid();b.focus(!0)},scope:this})}.createDelegate(this),c=new Ext.Window({title:"GeoNode Login",modal:!0,width:230,autoHeight:!0,layout:"fit",items:[{xtype:"form",autoHeight:!0,
labelWidth:55,border:!1,bodyStyle:"padding: 10px;",url:"/accounts/ajax_login",waitMsgTarget:!0,errorReader:{read:function(a){return{success:200==a.status,records:[]}}},defaults:{anchor:"100%"},items:[{xtype:"textfield",name:"username",fieldLabel:"Username"},{xtype:"textfield",name:"password",fieldLabel:"Password",inputType:"password"},{xtype:"hidden",name:"csrfmiddlewaretoken",value:a},{xtype:"button",text:"Login",inputType:"submit",handler:b}]}],keys:{key:Ext.EventObject.ENTER,fn:b}});c.show();var d=
c.items.get(0);d.items.get(0).focus(!1,100)},displayXHRTrouble:function(a){a.status&&Ext.Msg.show({title:this.connErrorTitleText,msg:this.connErrorText,icon:Ext.MessageBox.ERROR,buttons:{ok:this.connErrorDetailsText,cancel:!0},fn:function(b){if("ok"==b){var c=new Ext.Window({title:a.status+" "+a.statusText,width:400,height:300,items:{xtype:"container",cls:"error-details",html:a.responseText},autoScroll:!0,buttons:[{text:"OK",handler:function(){c.close()}}]});c.show()}}})},loadLayerSources:function(){var a=
null,b;for(b in this.layerSources)f=this.layerSources[b],f.store&&f instanceof gxp.plugins.WMSSource&&f.url.indexOf("/geoserver/wms"===0)&&(a=b,f.store.on("load",function(){f.store.filterBy(function(a){a=a.get("name");return!(/geonode:_map_[0-9]+_annotations/.test(a)||/geonode:annotations_[0-9]+/.test(a))},this)},this));b=null;for(var c in this.tools){var d=this.tools[c];if("gxp_addlayers"===d.ptype)b=d,b.startSourceId=a}c=window.location.href.split("?");var e;if(1<c.length&&(e=Ext.urlDecode(c[1]).layer)){var f=
this.layerSources[a];if(f.lazy)lyrParts=e.split(":"),e=lyrParts[1],f.store.url=f.store.url.replace(/(geoserver)(\/.*?)(wms)/,function(a,b,c,d){return[b].concat(lyrParts,d).join("/")}),f.store.proxy.setUrl(f.store.url);this.createLayerRecord({source:a,name:e},function(a){this.mapPanel.layers.add([a]);this.mapPanel.map.zoomToExtent(a.getLayer().maxExtent)},this)}!e&&!this.mapID&&null!==b&&b.showCapabilitiesGrid()}});Ext.reg("gn_viewer",GeonodeViewer);Ext.preg("gx_wmssource",gxp.plugins.WMSSource);
Ext.preg("gx_olsource",gxp.plugins.OLSource);Ext.preg("gx_googlesource",gxp.plugins.GoogleSource);
(function(){Ext.ns("mapstory.plugins");mapstory.plugins.AddLayers=Ext.extend(gxp.plugins.Tool,{ptype:"ms_add_layer",addActions:function(){return mapstory.plugins.AddLayers.superclass.addActions.apply(this,[{iconCls:"gxp-icon-addlayers",scope:this,handler:function(){(new window.mapstory.LayerSearch({geoExplorer:this.target,map:this.target.mapPanel.map,searchUrl:"/search/api"})).render()}}])}});Ext.preg(mapstory.plugins.AddLayers.prototype.ptype,mapstory.plugins.AddLayers)})();Ext.ns("mapstory.plugins");
mapstory.plugins.CatalogueSource=Ext.extend(gxp.plugins.GeoNodeCatalogueSource,{ptype:"ms_cataloguesource",hidden:!1,rootProperty:"rows",minChars:3,minCharsTitle:"Layer Search",minCharsError:"Please specify at least {count} characters",fields:[{name:"name"},{name:"id"},{name:"title"},{name:"abstract"},{name:"thumb"},{name:"owner"},{name:"owner_detail"},{name:"_display_type"},{name:"last_modified"},{name:"views"},{name:"rating"},{name:"_type"},{name:"owsUrl",convert:function(a){return-1!==a.indexOf("/wms")||
-1!==a.indexOf("/ows")?a:"/"===a.charAt(a.length-1)?a+"ows":a+"/ows"}}],baseParams:{limit:0,sort:"alphaaz"},constructor:function(a){mapstory.plugins.CatalogueSource.superclass.constructor.apply(this,arguments);this.on("ready",function(){this.store.on("beforeload",function(a){void 0!==a.baseParams.q&&a.baseParams.q.length<this.minChars&&Ext.Msg.alert(this.minCharsTitle,(new Ext.Template(this.minCharsError)).apply({count:this.minChars}));return void 0!==a.baseParams.q&&a.baseParams.q.length>=this.minChars},
this)},this)},createLayerRecord:function(a,b,c){var d=this.store.findExact("name",a.name);if(-1!==d){var d=this.store.getAt(d).get("owsUrl"),e=-1!==a.name.indexOf(":")?a.name.split(":")[1]:a.name,f,g;for(g in this.target.layerSources){var h=this.target.layerSources[g];if(h.restUrl)f=h.restUrl}var a=a.name+"-"+a.source,i=(g=this.target.layerSources[a])||this.target.addLayerSource({id:a,config:{isLazy:OpenLayers.Function.False,ptype:"gxp_wmscsource",hidden:!0,restUrl:f,version:"1.1.1",url:d}});if(g)this.target.createLayerRecord({source:i.id,
name:e},b,c);else i.on({ready:function(){this.target.createLayerRecord({source:i.id,name:e},b,c)},scope:this})}}});Ext.preg(mapstory.plugins.CatalogueSource.prototype.ptype,mapstory.plugins.CatalogueSource);Ext.ns("mapstory");mapstory.Editor=Ext.extend(GeonodeViewer,{});Ext.reg("ms_editor",mapstory.Editor);Ext.ns("mapstory");
mapstory.LayerViewer=Ext.extend(GeonodeViewer,{getDefaultTools:function(){return[{ptype:"gxp_playback",id:"playback-tool",outputTarget:"map",looped:!0,outputConfig:{xtype:"app_playbacktoolbar",width:570,defaults:{scale:"medium"},playbackActions:["play","slider","loop","fastforward","prev","next",{xtype:"tbspacer"},"legend",{xtype:"tbfill"},"settings",{xtype:"tbspacer"},"togglesize"]}}]},initMapPanel:function(){this.initialConfig.map=Ext.applyIf(this.initialConfig.map||{},{region:"center",ref:"../main"});
this.initialConfig.map.id="msmap";mapstory.LayerViewer.superclass.initMapPanel.call(this);var a=new OpenLayers.TileManager({cacheSize:512,tilesPerFrame:24});this.mapPanel.map.tileManager=a;a.addMap(this.mapPanel.map)},initPortal:function(){var a={height:450};this.portalConfig=this.portalConfig?Ext.applyIf(this.portalConfig,a):a;this.portalItems=[{xtype:"panel",region:"south",hidden:!0,layout:"fit",tbar:["->"],id:"timeline-container",collapsible:!1,header:!1,collapsed:!0,height:150},"msmap"];mapstory.LayerViewer.superclass.initPortal.call(this)}});
Ext.reg("ms_layerviewer",mapstory.LayerViewer);Ext.ns("mapstory.plugins");Ext.Tip.prototype.defaultAlign="tr-tr?";Ext.ns("Ext.ux.util");
Ext.ux.util.HiddenForm=function(a,b){if(Ext.isArray(b)){var c=Ext.getBody(),d=c.createChild({tag:"iframe",cls:"x-hidden",id:"hiddenform-iframe",name:"iframe"}),e=c.createChild({tag:"form",cls:"x-hidden",method:"GET",id:"hiddenform-form",action:a,target:"iframe"});Ext.each(b,function(a){if(!Ext.isArray(a))return!1;e.createChild({tag:"input",type:"text",cls:"x-hidden",id:"hiddenform-"+a[0],name:a[0],value:a[1]})});e.dom.submit();return d}};
mapstory.plugins.NotesManager=Ext.extend(gxp.plugins.Tool,{ptype:"ms_notes_manager",timeline:null,menuText:"Manage annotations",gridTitle:"Mapstory Annotations",insertText:"Insert",insertMsg:"Another insert is in progress already",deleteText:"Delete",deleteMsg:"Are you sure you want to delete the currently selected annotation(s)?",promptDeleteLabel:"Prompt on delete",layerTitle:"Annotations",ruleTitle:"Annotations",saveTitle:"Annotations",saveMsg:'In order to add annotations, please save your map first by clicking the "Save Map" button:<div class="x-btn"><div class="ms-icon-save msgbox-button"></div></div>',
downloadText:"Download",uploadText:"Upload",uploadWaitMsg:"Uploading ...",uploadEmptyText:"Select a CSV file",uploadFieldLabel:"CSV",failureTitle:"Upload Error",mediaHtml:'Use <a href="http://wiki.mapstory.org/wiki/How_To#How_to_Annotate_Stories" target="_blank">media</a> in your annotations',isNewMap:null,outputAction:0,outputTarget:"foo",outputConfig:{layout:"fit",height:200,constrain:!0,closeAction:"hide"},createStore:function(a){this.annotationsEndPoint="/maps/"+a+"/annotations";this.store=new GeoExt.data.FeatureStore({autoSave:!1,
writer:new Ext.data.DataWriter({write:Ext.emptyFn}),fields:[{name:"geometry"},{name:"title",type:"string"},{name:"content",type:"string"},{name:"start_time",type:"integer",useNull:!0},{name:"end_time",type:"integer",useNull:!0},{name:"in_map",type:"boolean"},{name:"in_timeline",type:"boolean"},{name:"appearance",type:"string"}],proxy:new gxp.data.WFSProtocolProxy({protocol:new mapstory.protocol.Notes({format:new OpenLayers.Format.GeoJSON,baseUrl:this.annotationsEndPoint})}),autoLoad:!0});this.store.reader.getId=
function(a){return Ext.isObject(a)&&a.id};this.timelineTool&&(this.timelineTool.on("click",function(a){this.output[0]?this.output[0].ownerCt.show():this.addOutput();var c=this.store.getAt(this.store.findBy(function(c){return c.getFeature().fid===a})),d=this;window.setTimeout(function(){d.output[0].getSelectionModel().selectRecords([c])},250)},this),this.timelineTool.setAnnotationsStore(this.store))},init:function(a){this.timelineTool=a.tools[this.timeline];this.playback=a.tools[this.timelineTool.playbackTool];
this.appearanceData=[["tl-tl?","Top left"],["t-t?","Top center"],["tr-tr?","Top right"],["l-l?","Center left"],["c-c?","Center"],["r-r?","Center right"],["bl-bl?","Bottom left"],["b-b?","Bottom center"],["br-br?","Bottom right"],["geom","Next to geometry"]];mapstory.plugins.NotesManager.superclass.init.apply(this,arguments);if(null!==this.target.id)this.createStore(this.target.id);else this.target.on("saved",function(a){this.createStore(a)},this,{single:!0})},addOutput:function(){if(null===this.target.id&&
null===this.target.mapID)Ext.Msg.show({icon:Ext.Msg.WARNING,title:this.saveTitle,msg:this.saveMsg,width:350,buttons:Ext.Msg.OK});else{this.target.mapPanel.map.events.on({preaddlayer:function(a){a.layer.name=this.layerTitle;a.layer.styleMap.styles["default"].title=this.ruleTitle;this.target.mapPanel.map.events.un({preaddlayer:arguments.callee,scope:this})},scope:this});var a=this;gxp.form.ExtendedDateField.prototype.getPickerDate=function(){var b=new Date(a.playback.playbackToolbar.control.currentValue);
b.setTime(b.getTime()+6E4*b.getTimezoneOffset());return b};var b=Ext.apply({},this.outputConfig);b.x=this.target.mapPanel.body.getLeft()+20;b.items=[{xtype:"gxp_featuregrid",viewConfig:{forceFit:!0},propertyNames:{in_map:"Map",in_timeline:"Timeline",start_time:"Start Time",end_time:"End Time",title:"Title",content:"Content",appearance:"Annotation Location"},tbar:[{text:this.deleteText,iconCls:"gxp-icon-removelayers",handler:function(){var a=this.output[0].getSelectionModel().getSelections();if(a&&
0<a.length){var b=function(a){for(var b=0,c=a.length;b<c;++b){var d=a[b];d.getFeature().state=OpenLayers.State.DELETE;this.store.remove(d)}this.store.save()};this.output[0].promptOnDelete.getValue()?Ext.Msg.show({title:this.deleteText,msg:this.deleteMsg,buttons:Ext.Msg.YESNOCANCEL,fn:function(c){"yes"===c&&b.call(this,a)},scope:this}):b.call(this,a)}},scope:this},{text:this.insertText,iconCls:"gxp-icon-addlayers",handler:function(){var a=!1;this.store.each(function(b){if(b.getFeature().state===OpenLayers.State.INSERT)return a=
!0,!1});if(!0===a)Ext.Msg.show({title:this.insertText,msg:this.insertMsg,cls:"row-editor-msg-box",buttons:Ext.Msg.OK});else{var b=this.output[0].plugins[0];b.stopEditing();var c=GeoExt.data.FeatureRecord.create([{name:"title"},{name:"content"},{name:"in_map"},{name:"in_timeline"},{name:"start_time"},{name:"end_time"},{name:"appearance"}]),g=new OpenLayers.Feature.Vector;g.state=OpenLayers.State.INSERT;this.store.insert(0,new c({feature:g,in_map:!0,in_timeline:!0}));this.output[0].getView().refresh();
this.output[0].getSelectionModel().selectRow(0);b.startEditing(0);b.on("canceledit",function(){this.store.getAt(0).getFeature().state===OpenLayers.State.INSERT&&this.store.removeAt(0)},this,{single:!0})}},scope:this},{text:this.uploadText,handler:function(){var a=new Ext.FormPanel({width:400,title:this.uploadText,bodyStyle:"padding: 10px 10px 0 10px;",labelWidth:50,defaults:{anchor:"95%",allowBlank:!1,msgTarget:"side"},fileUpload:!0,items:[{xtype:"hidden",name:"csrfmiddlewaretoken",value:Ext.util.Cookies.get("csrftoken")},
{xtype:"fileuploadfield",emptyText:this.uploadEmptyText,fieldLabel:this.uploadFieldLabel}],footerCfg:{tag:"div",children:[{tag:"div",style:"position:absolute; margin: 5px 0 0 10px;",children:[{html:'<a href="/mapstory/manual/#bulk-upload-of-annotations" target="_blank">Learn More</a>'}]}]},buttons:[{text:this.uploadText,handler:function(){var b=function(a,b){Ext.Msg.show({icon:Ext.Msg.ERROR,title:this.failureTitle,msg:b.response.responseText,width:350,buttons:Ext.Msg.OK})};a.getForm().isValid()&&
a.getForm().submit({url:this.annotationsEndPoint,waitMsg:this.uploadWaitMsg,success:function(a,c){Ext.decode(c.response.responseText).success?(this.uploadWindow.close(),delete this.uploadWindow,this.store.load()):b.call(this,a,c)},failure:b,scope:this})},scope:this}]});this.uploadWindow=(new Ext.Window({items:[a]})).show()},scope:this},{text:this.downloadText,handler:function(){Ext.ux.util.HiddenForm(this.annotationsEndPoint,[["csv",""]])},scope:this},"->",{xtype:"checkbox",ref:"../promptOnDelete",
boxLabel:this.promptDeleteLabel,checked:!0}],ignoreFields:["geometry"],plugins:[new gxp.plugins.GeoRowEditor({monitorValid:!1,listeners:{buttonrender:function(b,c){c.width+=350;c.add({xtype:"box",width:350,style:"text-align:right",html:a.mediaHtml});c.doLayout()},beforeedit:function(a,b){var c=this.grid.store.getAt(b);Ext.getCmp("start-time").rendered?Ext.getCmp("start-time").setValue(c.get("start_time")):Ext.getCmp("start-time").value=c.get("start_time");Ext.getCmp("end-time").rendered?Ext.getCmp("end-time").setValue(c.get("end_time")):
Ext.getCmp("end-time").value=c.get("end_time")},afteredit:function(a,b,c){null!==c.getFeature().geometry&&Ext.isEmpty(c.get("appearance"))&&c.set("appearance","geom");null===c.getFeature().geometry&&"geom"===c.get("appearance")&&c.set("appearance","")}},scope:this})],columnConfig:{in_timeline:{width:75},in_map:{width:50},start_time:{width:200},end_time:{width:200},appearance:{width:115}},customEditors:{in_map:{xtype:"checkbox"},in_timeline:{xtype:"checkbox"},start_time:{id:"start-time",listeners:{beforeshow:function(b){var c=
a.playback.playbackToolbar.slider.timeFormat;c===gxp.PlaybackToolbar.timeFormats.Hours||c===gxp.PlaybackToolbar.timeFormats.Minutes?b.time.show():b.time.hide()}},xtype:"gxp_datetimefield",todayText:"Now",selectToday:function(){var b=new Date(a.playback.playbackToolbar.control.currentValue);b.setTime(b.getTime()+6E4*b.getTimezoneOffset());this.setValue(b);this.fireEvent("select",this,this.value)}},end_time:{id:"end-time",listeners:{beforeshow:function(b){var c=a.playback.playbackToolbar.slider.timeFormat;
c===gxp.PlaybackToolbar.timeFormats.Hours||c===gxp.PlaybackToolbar.timeFormats.Minutes?b.time.show():b.time.hide()}},xtype:"gxp_datetimefield",todayText:"Now",selectToday:function(){var b=new Date(a.playback.playbackToolbar.control.currentValue);b.setTime(b.getTime()+6E4*b.getTimezoneOffset());this.setValue(b);this.fireEvent("select",this,this.value)}},content:{xtype:"textarea"},appearance:{xtype:"combo",mode:"local",triggerAction:"all",store:this.appearanceData}},customRenderers:{content:"htmlEncode",
start_time:function(a){return gxp.form.ExtendedDateField.prototype.setValue(a).value},end_time:function(a){return gxp.form.ExtendedDateField.prototype.setValue(a).value},in_map:function(a){return"<input disabled='true' type='checkbox'"+(a?"checked='checked'":"")+">"},in_timeline:function(a){return"<input disabled='true' type='checkbox'"+(a?"checked='checked'":"")+">"},appearance:function(b){if(Ext.isEmpty(b))b=Ext.Tip.prototype.defaultAlign;for(var c=0,f=a.appearanceData.length;c<f;++c)if(a.appearanceData[c][0]===
b)return a.appearanceData[c][1]}},store:this.store,map:this.target.mapPanel.map}];var b=(new Ext.Window(b)).show(),c=b.items.get(0);this.output=[c];b.on("hide",function(){c.getSelectionModel().clearSelections();c.plugins[0].stopEditing();var a=!1;this.store.each(function(b){if(b.getFeature().state===OpenLayers.State.INSERT)return a=!0,!1});!0===a&&this.store.getAt(0).getFeature().state===OpenLayers.State.INSERT&&this.store.removeAt(0)},this);return b}},addActions:function(){return mapstory.plugins.NotesManager.superclass.addActions.apply(this,
[{hidden:!this.target.isAuthorized(),iconCls:"gxp-icon-note",tooltip:this.menuText}])}});Ext.preg(mapstory.plugins.NotesManager.prototype.ptype,mapstory.plugins.NotesManager);Ext.ns("mapstory.protocol");
mapstory.protocol.Notes=OpenLayers.Class(OpenLayers.Protocol,{initialize:function(a){if(!a.baseUrl)throw Error("You must provide a baseUrl for mapstory.protocol.Notes");OpenLayers.Protocol.prototype.initialize.apply(this,arguments)},read:function(a){OpenLayers.Protocol.prototype.read.apply(this,arguments);var b=new OpenLayers.Protocol.Response({requestType:"read"});b.priv=OpenLayers.Request.GET({url:this.baseUrl,callback:this.createCallback(this.readFeatures,b,a)});return b},readFeatures:function(a,
b){a.features=this.format.read(a.priv.responseText);a.code=OpenLayers.Protocol.Response.SUCCESS;b.callback.call(b.scope,a)},commit:function(a,b){var c;if(0<a.length&&a[0].state===OpenLayers.State.DELETE){var d={action:"delete",ids:[]};c=0;for(var e=a.length;c<e;++c)d.ids.push(a[c].fid);c=new OpenLayers.Protocol.Response({requestType:"delete",reqFeatures:a});c.priv=OpenLayers.Request.POST({url:this.baseUrl,headers:b.headers,data:(new OpenLayers.Format.JSON).write(d),callback:this.createCallback(this.handleCommit,
c,b)});return c}if(0<a.length&&a[0].state===OpenLayers.State.INSERT)return c=new OpenLayers.Protocol.Response({requestType:"create",reqFeatures:a}),c.priv=OpenLayers.Request.POST({url:this.baseUrl,headers:b.headers,data:this.format.write(a,b),callback:this.createCallback(this.handleCommit,c,b)}),c;c=new OpenLayers.Protocol.Response({requestType:"update",reqFeatures:a});c.priv=OpenLayers.Request.POST({url:this.baseUrl,headers:b.headers,data:this.format.write(a,b),callback:this.createCallback(this.handleCommit,
c,b)});return c},handleCommit:function(a,b){if(b.callback){var c=Ext.decode(a.priv.responseText);a.code=c.success?OpenLayers.Protocol.Response.SUCCESS:OpenLayers.Protocol.Response.FAILURE;if("create"===a.requestType)a.insertIds=c.ids;if(!c.success)a.error=c;b.callback.call(b.scope,a)}},CLASS_NAME:"mapstory.protocol.Notes"});
(function(){Ext.ns("mapstory.plugins");mapstory.plugins.ToolBar=Ext.extend(gxp.plugins.Tool,{ptype:"ms-tool-bar",publishText:"Publish Map",zoomText:"Number of zoom levels",wrapDateLineText:"Wrap dateline",colorText:"Background color",suppressOutput:!1,buildSaveForm:function(){var a=this.target,b=this.target.mapPanel.map.baseLayer,c=Ext.get(this.target.mapPanel.map.getViewport()),d=function(a,b){var c=Ext.getCmp("saveForm").getForm().getValues();a.about.title=c.mapTitle;a.about["abstract"]=c.mapAbstract;
b?a.save(!0):a.save();a.metadataForm.hide()},e=new Ext.Button({text:a.metadataFormSaveText,handler:function(){d(this,!1)},scope:a}),f=new Ext.Button({text:a.metadataFormSaveAsCopyText,handler:function(){d(this,!0)},scope:a});return new Ext.Window({title:a.metaDataHeader,closeAction:"hide",width:400,items:[{xtype:"form",labelAlign:"top",bodyStyle:{padding:"5px"},id:"saveForm",items:[{xtype:"textfield",id:"mapTitle",width:"95%",fieldLabel:a.metaDataMapTitle,allowBlank:!1,value:a.about.title,listeners:{valid:function(){e.enable();
f.enable()},invalid:function(){e.disable();f.disable()}}},{xtype:"textarea",id:"mapAbstract",width:"95%",height:200,fieldLabel:a.metaDataMapAbstract,value:a.about["abstract"]},{xtype:"numberfield",allowNegative:!1,allowDecimals:!1,fieldLabel:this.zoomText,hidden:!0,value:b.numZoomLevels,listeners:{change:function(a,c){b.addOptions({numZoomLevels:c});this.target.mapPanel.map.events.triggerEvent("changebaselayer",{layer:b})},scope:this}},{xtype:"checkbox",fieldLabel:this.wrapDateLineText,hidden:!0,
checked:b.wrapDateLine,listeners:{check:function(a,c){b.wrapDateLine=c},scope:this}},{xtype:"gxp_colorfield",fieldLabel:this.colorText,value:c.getColor("background-color"),listeners:{valid:function(a){c.setStyle("background-color",a.getValue())},scope:this}}]}],bbar:["->",e,f]})},getState:function(){var a=this.target.mapPanel.map.baseLayer;return{ptype:this.ptype,bgColor:Ext.get(this.target.mapPanel.map.getViewport()).getColor("background-color"),numZoomLevels:a.numZoomLevels,wrapDateLine:!1}},addOutput:function(){var a=
Ext.get(this.target.mapPanel.map.getViewport()),b=this.target.mapPanel.map.baseLayer,c=this.initialConfig;c.bgColor&&a.setStyle("background-color",this.initialConfig.bgColor);c.numZoomLevels&&(b.addOptions({numZoomLevels:c.numZoomLevels}),this.target.mapPanel.map.events.triggerEvent("changebaselayer",{layer:b}));b.wrapDateLine=!1;return!this.suppressOutput&&mapstory.plugins.ToolBar.superclass.addOutput.call(this,{xtype:"toolbar",id:"ms-toolbar",defaults:{scale:"medium",height:31},items:[{xtype:"button",
iconCls:"ms-icon-save",tooltip:"Save map",scope:this,handler:function(){if(!this.target.metadataForm)this.target.metadataForm=this.buildSaveForm();this.target.metadataForm.show()}},{xtype:"button",iconCls:"ms-icon-timeline",tooltip:"Show timeline",scope:this,handler:function(){Ext.getCmp("timeline-container").toggleCollapse()}}]})}});Ext.preg(mapstory.plugins.ToolBar.prototype.ptype,mapstory.plugins.ToolBar)})();Ext.ns("mapstory");
mapstory.Viewer=Ext.extend(mapstory.LayerViewer,{getDefaultTools:function(){return[{ptype:"gxp_playback",id:"playback-tool",outputTarget:"map",looped:!0,outputConfig:{xtype:"app_playbacktoolbar",width:570,defaults:{scale:"medium"}}},{ptype:"gxp_timeline",id:"timeline-tool",outputConfig:{title:null},outputTarget:"timeline-container",playbackTool:"playback-tool"},{ptype:"ms_notes_manager",timeline:"timeline-tool"}]},initMapPanel:function(){mapstory.Viewer.superclass.initMapPanel.call(this)},initPortal:function(){mapstory.Viewer.superclass.initPortal.call(this)}});
Ext.reg("ms_viewer",mapstory.Viewer);
